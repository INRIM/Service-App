<html>
<head>
    {% block head %}
        <title>INRiM {{ app_name }}</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta http-equiv="Pragma" content="no-cache">
        <meta name="viewport"
              content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="icon" href="/static/favicon/favicon.ico">
        <meta name="theme-color" content="#0066CC">
        {#
    <meta http-equiv="refresh" content="{{ period if period else 3600 }}">
    #}
        {% block styles %}
            <link rel="stylesheet" type="text/css"
                  href="/static/css/project.css">
            <link rel="stylesheet" type="text/css"
                  href="/static/css/bootstrap-italia.min.css">
            <link rel="stylesheet" type="text/css"
                  href="/static/css/flatpickr.min.css">
            <link rel="stylesheet" type="text/css"
                  href="/static/css/material_blue.css">
            {#
        <link rel="stylesheet" type="text/css" href="/static/css/sticky-footer.css">
        #}
            <link rel="stylesheet" type="text/css"
                  href="/static/DataTables/datatables.min.css"/>
            <link rel="stylesheet"
                  href="/static/jQuery-QueryBuilder/css/query-builder.default.css">
            {#    <link rel="stylesheet" href="/static/jQuery-QueryBuilder/css/query-builder.dark.css">#}
            <link rel="stylesheet" type="text/css"
                  href="/static/qr/css/qrcode-reader.min.css"/>
            <link rel="stylesheet"
                  href="/static/jsonEditor/jsoneditor.min.css"/>

        {% endblock %}
    {% endblock %}
</head>
<body>
{% block script %}
    <script nonce="2726c7f26c">window.__PUBLIC_PATH__ = "/static/fonts"</script>
    <script type="text/javascript"
            src="/static/js/bootstrap-italia.bundle.min.js"
            nonce="2726c7f27c"></script>
    <script type="text/javascript" src="/static/DataTables/datatables.min.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript" src="/static/qr/js/qrcode-reader.min.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript"
            src="/static/moment/moment-with-locales.min.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript" src="/static/js/flatpickr.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript" src="/static/js/flatpickr_it.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript"
            src="/static/jquery_plugin/jquery.validate.min.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript"
            src="/static/jQuery-QueryBuilder/js/query-builder.standalone.min.js"
            nonce="2726c7f26c"></script>

    <script type="text/javascript" src="/static/jsonEditor/jsoneditor.min.js"
            nonce="2726c7f26c"></script>

    <script type="text/javascript"
            src="/static/jquery_plugin/jquery.inputmask.min.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript" src="/static/js/ckeditor.js"
            nonce="2726c7f26c"></script>
    <script type="text/javascript" src="/static/js/project.js"
            nonce="2726c7f26c"></script>

{% endblock %}

{% block header %}{% endblock %}

{% block loader %}
    <style>
        #global_progress_loader {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10001;
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
        }

        #loader_progress {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            cursor: not-allowed;
        }

        #automation_progress_loader {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10001;
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.88);
            cursor: not-allowed;
        }

        .ozon-progress-global {
            height: 5px;
            background-color: #ffffff;
        }

        .ozon-progress-global .progress-bar {
            #background-color: #673AEC;
        }

        .error {
            width: auto;
            position: relative !important;
            color: red;
        }

        .alert-danger {
            background-position: 20px 7px;
            margin-bottom: 2rem;
        }

        div.dropdown-menu {
            width: max-content;
        }

        .ozon-process-loader img {
            position: absolute;
            margin: auto;
            top: 25%;
            left: 0;
            right: 0;
            width: 25%;
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .bootstrap-select > .btn {
            background-color: #FFF !important;
        }

        .bootstrap-select > .btn.select_diabled {
            background-color: rgb(231, 233, 242) !important;
        }

        .text_area_disabled {
            background-color: rgb(231, 233, 242);
        }

    </style>
    <div class=" d-none" id="global_progress_loader">
        <div id="loader_progress">
            <div class="progress progress-indeterminate ozon-progress-global">
                <span class="sr-only">In elaborazione...</span>
                <div class="progress-bar" role="progressbar"></div>
            </div>
        </div>
    </div>
    <div class=" d-none" id="automation_progress_loader">
        <div class="ozon-process-loader">
            <span class="sr-only">In elaborazione...</span>
            <img src="/static/img/process_x.gif">
        </div>
    </div>
    <script>
        window.formJsonEditor = false;
        window.formeditor = false;
        window.fileManager = {
            fields: []
        };
    </script>
{% endblock %}
<main class="mt-1">
    {% block content %}{% endblock %}
</main>
{% block footer %}
{% endblock %}

<script type="text/javascript" nonce="{{ nonce or '2726c7f26c' }}">
    let previousPageUrl = document.referrer;
    let url = previousPageUrl;
    if (previousPageUrl !== "") {
        if (!previousPageUrl.includes("container_act=s")) {
            url = `${previousPageUrl}?container_act=s`;
        }
    }

    window.addEventListener("pageshow", function (event) {
        const entries = performance.getEntriesByType("navigation");
        entries.forEach((entry) => {
            if (entry.type !== "realod" && event.persisted) {
                window.location.reload();
            }
        });
    });

    function btn_back() {
        if (url !== "") {

            let local_loader = $("#global_progress_loader");
            if (local_loader !== undefined) {
                local_loader.removeClass("d-none");
            }
            gotolink(url);

        } else {
            window.close();
        }
    }


    $(document).on('click', "a", function (e) {
        let form = $(this).closest('form').get(0);
        if (!form) {
            if (
                $(this).attr('href') !== undefined &&
                $(this).attr('href') !== '#' &&
                !$(this).attr('href').includes("blob")
            ) {
                $(document).unbind("click");
                $("#global_progress_loader").removeClass("d-none");
            }
        }
    });

    function gotolink(link) {

        window.location.href = link;
        //window.location.replace(link)
    }

    function clean_key_id(field_id) {
        return field_id.replace(/_in([^_in]*)$/, '')
            .replace(/_lt([^_lt]*)$/, '')
            .replace(/_tl([^_tl]*)$/, '')
            .replace(/_ck([^_ck]*)$/, '')
            .replace(/_sel([^_sel]*)$/, '');
    }

    function jsonForm(form_name) {
        let form = document.getElementById(form_name);
        //console.log($(form).serialize())
        let formData = new FormData(form);
        let obj = Object.fromEntries(
            Array.from(formData.keys()).map(key => [
                clean_key_id(key), formData.getAll(key).length > 1 ? formData.getAll(key) : formData.get(key)]));
        return obj;
    }

    function dataForm(form_name, related_action) {
        let form = document.getElementById(form_name);
        let jsonform = jsonForm(form_name)
        if (window.formJsonEditor && window.formJsonEditor.options.hasOwnProperty("editable")) {
            jsonform[window.formJsonEditor.options.field] = window.formJsonEditor.get()
        }
        if (window.formeditor) {
            jsonform[window.formeditor.field] = window.formeditor.editor.getData();
        }
        let formData = new FormData();
        if (window.fileManager.fields.length > 0) {
            window.fileManager.fields.forEach(function (value, index) {
                let inputfiles = $("#" + value.input_files);
                if (inputfiles) {
                    let i = 0, len = inputfiles.length;
                    for (; i < len; i++) {
                        let filedi = inputfiles[i];
                        let lenfile = filedi.files.length;
                        if (lenfile > 0) {
                            formData.append(value.field, filedi.files[0]);
                        }

                    }
                }
                jsonform[value.field] = []
                $("#" + value.list_exist + " li").each(function () {
                    jsonform[value.field].push(
                        {
                            key: $(this).data("id"),
                            filename: $(this).data("filename"),
                            content_type: $(this).data("content_type"),
                            file_path: $(this).data("file_path"),
                            url: $(this).data("url")
                        }
                    )
                })

            });

        }
        //let fileArr = [];

        if (related_action) {
            jsonform['related_action'] = related_action;
        }

        formData.append('formObj', JSON.stringify(jsonform));

        return formData;
    }

    function close_modal() {
        $('#FormModal').modal('hide');
        $("#global_progress_loader").removeClass("d-none");
        $(document).find("input").prop('readonly', true);
        $('#btn_submit').prop('disabled', true);
        window.location.reload();
    }

    function scorll_at(pos) {
        $("html, body").animate({scrollTop: pos}, "slow");
    }

    function execute_ajax(
        req_type, req_url, obj, loader = "loader", form, nojson, callback, modal, callbackParam) {
        let data_to_send = JSON.stringify(obj);
        let Content_Type = "application/json";
        let is_async = true;
        let processData = true;
        let focused = document.activeElement;
        if (nojson) {
            data_to_send = obj;
            Content_Type = false;
            processData = false;
        }
        $.ajax({
            type: req_type,
            url: req_url,
            headers: {
                {% if security_headers %}
                    {% for k,v in security_headers.items() %}
                        "{{ k }}": "{{ v }}",
                    {% endfor %}
                {% endif %}
            },
            async: is_async,
            cache: false,
            contentType: Content_Type,
            processData: processData,
            data: data_to_send,
            beforeSend: function () {
                $("#" + loader).removeClass("d-none");
                if (form) {
                    $('#' + form + "_alert").empty();
                    $('#' + form + "_alert").hide();
                    $('#' + form + " select, input:checkbox, input:radio").prop('readonly', true);
                    $('#btn_submit').prop('disabled', true);
                }
            },
            error: function (e) {
                $("#" + loader).addClass("d-none");
                if (form) {
                    $('#' + form + " :input").prop('readonly', false);
                    $('#btn_submit').prop('disabled', false);
                }
                alert("Errore Interno contattare Helpdesk", e);
            },
            success: function (result) {

                if ((result.hasOwnProperty('link')) && result.reload) {
                    console.log(result, modal)
                    if (result.link === "#") {
                        if (callback) {
                            $("#" + loader).addClass("d-none");
                            if (callbackParam){
                                callback(callbackParam);
                            }else{
                                callback();
                            }


                        } else {
                            window.location.reload();
                        }

                    } else {
                        if (callback) {
                            console.log(callback, result.link);
                            $("#" + loader).addClass("d-none");
                            callback(result.link);

                        } else {
                            console.log("gotolink", result.link)
                            gotolink(result.link);
                        }

                    }
                } else if (result.hasOwnProperty('status')) {
                    $("#" + loader).addClass("d-none");
                    if (result.status === "error") {
                        alert("error");
                    }
                    if (form) {
                        $('#' + form + " :input").prop('readonly', false);
                        $('#btn_submit').prop('disabled', false);

                    }
                } else {
                    if (result.hasOwnProperty('body')) {
                        let modal_container = $("#modal_ph");

                        let html = result.body;
                        modal_container.html(html);
                        $('#FormModal').modal('show');
                        //$("#" + loader).addClass("d-none");
                    }

                    if (!result.hasOwnProperty('link') && !result.hasOwnProperty('body')) {
                        $("#" + loader).addClass("d-none");
                        for (let item in result) {
                            $(result[item].selector).replaceWith(result[item].value);
                            $(result[item].value).find("select, textarea, input").focus({preventScroll: true});
                            $(result[item].value).find("select, textarea, input").blur();
                            //$(result[item].selector).load(location.href + " "+ result[item].selector,"");
                        }
                        if (callback) {
                            if (callbackParam){
                                callback(callbackParam);
                            }else{
                                callback();
                            }
                        }
                        if (!(result.hasOwnProperty('link'))) {
                            for (let item in result) {
                                if (result[item].selector.includes('alert')) {
                                    let yc = $(result[item].selector).offset().top;
                                    scorll_at(yc);
                                    break;
                                }
                            }
                        }


                    }

                    $("#" + loader).addClass("d-none");
                    if (form) {
                        $('#' + form + " select, input:checkbox, input:radio").prop('readonly', false);
                        $('#btn_submit').prop('disabled', false);
                    }
                }


            },
        });
    }


    let config = {
        extendAliases: {
            label: {regex: "((\d{2})?[-](\d{6}))"},
            "url": {
                definitions: {
                    "i": {
                        validator: ".",
                        cardinality: 1
                    }
                },
                mask: "(\\http\\s://)|(\\http://)|(ftp\\s://)|(ftp://)|(\\ldap\\s:)|(\\ldap:)i{+}",
                insertMode: false,
                autoUnmask: false
            },
            'sci': {
                alias: 'numeric',
                radixPoint: '.',
                groupSeparator: '',
                autoGroup: true,
                placeholder: ''
            },
            'numericit': {
                alias: 'numeric',
                digits: '*',
                radixPoint: '.',
                groupSeparator: ',',
                autoGroup: true,
                placeholder: ''
            },
            'currency': {
                alias: 'numericit',
                digits: '*',
                digitsOptional: true,
                radixPoint: ',',
                groupSeparator: '.',
                autoGroup: true,
                placeholder: ''
            },
            'euro': {
                alias: 'currency',
                prefix: '',
                suffix: ' €',
                radixPoint: ',',
                groupSeparator: '',
                autoGroup: false,
            },
            'euroComplex': {
                alias: 'currency',
                prefix: '',
                suffix: ' €',
            },
            mac: {
                casing: "lower",
            },
        }
    };

    Inputmask.extendAliases(config.extendAliases);

    moment.locale("it");

    DecoupledEditor.defaultConfig = {
        toolbar: {
            items: [
                'heading',
                '|',
                'fontfamily',
                'fontsize',
                'fontColor',
                'fontBackgroundColor',
                '|',
                'bold',
                'italic',
                'underline',
                'strikethrough',
                '|',
                'alignment',
                '|',
                'numberedList',
                'bulletedList',
                '|',
                'indent',
                'outdent',
                '|',
                'link',
                'blockquote',
                //'imageUpload',
                'insertTable',
                // 'mediaEmbed',
                '|',
                'undo',
                'redo'
            ]
        },
        image: {
            styles: [
                'full',
                'alignLeft',
                'alignRight'
            ],
            toolbar: [
                'imageStyle:alignLeft',
                'imageStyle:full',
                'imageStyle:alignRight',
                '|',
                'imageTextAlternative'
            ]
        },
        table: {
            contentToolbar: [
                'tableColumn',
                'tableRow',
                'mergeTableCells',
                'tableProperties',
                'tableCellProperties'
            ]
        },
        language: 'it'
    };

    let client_id = Date.now()


    {% block js %}

    {% endblock %}
</script>
</body>
</html>
