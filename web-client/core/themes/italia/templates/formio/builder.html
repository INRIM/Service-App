<html>
<head>
    <link rel='stylesheet' href='/static/formio/css/dist/cosmo/bootstrap.min.css'>
    {#    <link rel='stylesheet' href='/static/formio/css/dist/sketchy/bootstrap.css'>#}
    <link rel='stylesheet' href='/static/formio/ckEditorCustom/editor.css'>
    <link rel='stylesheet' href='/static/formio/fontawesome/css/font-awesome.min.css'>
    <link rel='stylesheet' href='/static/formio/css/formio.full.min.css'>
    <link rel='stylesheet' href='/static/css/bootstrap-select.min.css'>
    <link rel="stylesheet" href="/static/jsonEditor/jsoneditor.min.css"/>
    <script src="/static/formio/js/jquery-3.5.1.min.js"
            crossorigin="anonymous"></script>
    <script src='/static/formio/js/formio.full.min.js'></script>
    <script src='/static/formio/js/bootstrap.min.js'></script>
    <script src='/static/jquery_plugin/jquery.validate.js'></script>
    <script src="/static/js/ckeditor.js"></script>
    <script src="/static/js/bootstrap-select.min.js"></script>
    <script type="text/javascript" src="/static/jsonEditor/jsoneditor.min.js"></script>
    <style>
        table {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }

        .formio-dialog .formio-dialog-content[ref="dialogContents"] {
            width: 91%;
        }
    </style>
    <script type="text/javascript">
        window.onload = function () {
            if (Formio) {
                Formio.icons = 'fontawesome';
                document.getElementById('renderer-version').innerHTML = Formio.version;
            }
        };
    </script>

</head>
<body>
<div class="col-12 bg-light mt-4">
    <form role="form" novalidate="" class="p-1" id="fproject">
        <input type="text" class="form-control d-none "
               id="type" name="type" placeholder="Form type" required
               value="{{ type|safe }}">

        <div class="row">
            <div class="col col-sm-4">
                <div id="form-group-title" class="form-group">
                    <label for="title" class="control-label">Titolo<span class="h5 text-danger">*</span></label>
                    <input type="text" class="form-control"
                           id="title" name="title" placeholder="Enter the form title" required
                           value="{{ title|safe }}"
                    >
                </div>
            </div>
            <div class="col col-sm-4">
                <div id="form-group-name" class="form-group">
                    <label for="rec_name" class="control-label">Name<span class="h5 text-danger">*</span></label>
                    <input type="text" class="form-control  "
                           id="rec_name" name="rec_name" placeholder="Enter the form machine name" required
                           value="{{ rec_name|safe }}">
                </div>
            </div>
            <div class="col col-sm-3">
                <div id="form-group-data_model" class="form-group">
                    <label for="data_model" class="control-label">Model</label>

                    <select id="data_model" name="data_model" class="form-control  ">
                        <option label="" value="" {% if data_model|string == "" %} selected {% endif %}>Si</option>
                        <option label="No Model" value="no_model" {% if (data_model|string == "no_model") %}
                                selected {% endif %}>No Model
                        </option>
                        {% for item in models %}
                            <option value="{{ item['rec_name'] }}" {% if (data_model|string ==  item['rec_name']) %}
                                    selected {% endif %}>{{ item['title'] }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Si: crea il model | | No: solo view senza storage dei dati | |
                        ?Mdole_name: crea una view alternativa per il model selezionato</small>
                </div>
            </div>
            <div class="col col-sm-1">
                <div id="form-group-form_sys" class="form-group">
                    <label for="sys" class="control-label">Sys</label>
                    <select id="sys" name="sys" class="form-control  ">
                        <option label="No" value="" {% if (not sys) %} selected {% endif %}>No</option>
                        <option label="Si" value="1" {% if (sys) %} selected {% endif %}>Si</option>
                    </select>
                </div>
            </div>
            <div class=" d-none">
                <div id="form-group-path" class="form-group">
                    <label for="path" class="control-label">Path</label>
                    <input type="text" class="form-control" id="path\"
                           name="path" placeholder="example" style="text-transform: lowercase">
                    <small>The path alias for this form.</small>
                </div>
            </div>
        </div>
        <div class="col-xs-12 ">

            <ul class="nav nav-tabs nav-fill" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#nav-builder"
                       role="tab"
                       aria-controls="nav-builder" aria-selected="true">Builder</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#nav-print" role="tab"
                       aria-controls="nav-print" aria-selected="false">Layout Stampa</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#nav-config" role="tab"
                       aria-controls="nav-config" aria-selected="false">Impostazioni</a>
                </li>
            </ul>
            <div class="tab-content py-3 px-3 px-sm-0">
                <div class="tab-pane active" id="nav-builder" role="tabpanel"
                     aria-labelledby="nav-builder-tab">
                    <input type="hidden" ng-model="form.type" autocomplete="off"
                           class=" ng-untouched ng-valid ng-not-empty">
                    <div id="builder_alert" class="col-md-12"></div>
                    <div class="col-lg-12">
                        <div id="builder"></div>
                    </div>
                </div>
                <div class="tab-pane " id="nav-print" role="tabpanel"
                     aria-labelledby="nav-print-tab">
                    <div class="row">
                        <div class="col col-sm-4">
                            <div id="form-group-rheader" class="form-group">
                                <label for="rheader" class="control-label">Stampa Header</label>
                                <select id="rheader" name="rheader" class="form-control  ">
                                    {% if 'rheader' in properties  and properties['rheader'] %}
                                        <option label="Si" value="1" {% if (properties['rheader']|string == "1") %}
                                                selected {% endif %}>Si
                                        </option>
                                        <option label="No" value="0" {% if (properties['rheader']|string == "0") %}
                                                selected {% endif %}>No
                                        </option>
                                    {% else %}
                                        <option label="Si" value="1" selected>Si</option>
                                        <option label="No" value="0">No</option>
                                    {% endif %}

                                </select>
                            </div>
                        </div>
                        <div class="col col-sm-4">
                            <div id="form-group-form_rfooter" class="form-group">
                                <label for="rfooter" class="control-label">Stampa Footer</label>
                                <select id="rfooter" name="rfooter" class="form-control  ">
                                    {% if 'rfooter' in properties  and properties['rfooter'] %}
                                        <option label="Si" value="1" {% if (properties['rfooter']|string == "1") %}
                                                selected {% endif %}>Si
                                        </option>
                                        <option label="No" value="0" {% if (properties['rfooter']|string == "0") %}
                                                selected {% endif %}>No
                                        </option>
                                    {% else %}
                                        <option label="Si" value="1" selected>Si</option>
                                        <option label="No" value="0">No</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="document-editor form-group">
                        <div id="toolbar-container" class="document-editor__toolbar"></div>
                        <!-- This container will become the editable. -->
                        <div class="document-editor__editable-container">
                            <div id="report" class="document-editor__editable">
                                {% if 'report' in properties %}
                                    {{ properties['report'] | safe }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="nav-config" role="tabpanel"
                     aria-labelledby="nav-config-tab">
                    <div class="row">
                        <div class="col col-sm-4">
                            <div id="form-group-title" class="form-group">
                                <label for="projectId" class="control-label">Progetto</label>
                                <input type="text" class="form-control"
                                       id="projectId" name="projectId" placeholder="Enter the form project" required
                                       value="{{ projectId|safe }}"
                                >
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col col-sm-3">
                            <div id="form-group-display" class="form-group">
                                <label for="display" class="control-label">Display as</label>
                                <select id="display" name="display" class="form-control  ">
                                    <option label="Form" value="form" selected="selected">Form</option>
                                    <option label="Wizard" value="wizard">Wizard</option>
                                </select>
                            </div>
                        </div>
                        <div class="col col-sm-2">
                            <div id="form-group-form_no_cancel" class="form-group">
                                <label for="no_cancel" class="control-label">Pulsante 'Abbandona'</label>
                                <select id="no_cancel" name="no_cancel" class="form-control  ">
                                    <option label="Si" value="0" {% if (no_cancel|string == "0") %}
                                            selected {% endif %}>Si
                                    </option>
                                    <option label="No" value="1" {% if (no_cancel|string == "1") %}
                                            selected {% endif %}>No
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col col-sm-2">
                            <div id="form-group-form_no_submit" class="form-group">
                                <label for="no_submit" class="control-label">Nascondi 'Submit'</label>
                                <select id="no_submit" name="no_submit" class="form-control  ">
                                    <option label="No" value="0" {% if (no_submit|string == "0") %}
                                            selected {% endif %}>No
                                    </option>
                                    <option label="Si" value="1" {% if (no_submit|string == "1") %}
                                            selected {% endif %}>Si
                                    </option>

                                </select>
                            </div>
                        </div>

                        <div class="col col-sm-2">
                            <div id="form-group-form_no_cancel" class="form-group">
                                <label for="no_cancel" class="control-label">Onchange Globlale</label>
                                <select id="handle_global_change" name="handle_global_change" class="form-control  ">
                                    <option label="Si" value="1" {% if (handle_global_change|string == "1") %}
                                            selected {% endif %}>
                                        Si
                                    </option>
                                    <option label="No" value="0" {% if (handle_global_change|string == "0") %}
                                            selected {% endif %}>
                                        No
                                    </option>
                                </select>
                                <small class="form-text text-muted">Usare per gestire le logiche automatiche</small>
                            </div>
                        </div>
                        <div class="col col-sm-2">
                            <div id="form-group-form_form_disabled" class="form-group">
                                <label for="form_disabled" class="control-label">Form Disabled</label>
                                <select id="form_disabled" name="form_disabled" class="form-control  ">
                                    <option label="No" value="0" {% if (form_disabled|string == "0") %}
                                            selected {% endif %}>No
                                    </option>
                                    <option label="Si" value="1" {% if (form_disabled|string == "1") %}
                                            selected {% endif %}>Si
                                    </option>
                                </select>
                                <small class="form-text text-muted">Imposta il form disabled</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col col-sm-4">
                            <div id="form-group-send_mail_create" class="form-group">
                                <label for="send_mail_create" class="control-label">Invia Mail alla creazione</label>
                                <select id="send_mail_create" name="send_mail_create" class="form-control  ">
                                    {% if 'send_mail_create' in properties  and properties['send_mail_create'] %}
                                        <option label="Si" value="1"
                                                {% if (properties['send_mail_create']|string == "1") %}
                                                selected {% endif %}>Si
                                        </option>
                                        <option label="No" value="0"
                                                {% if (properties['send_mail_create']|string == "0") %}
                                                selected {% endif %}>No
                                        </option>
                                    {% else %}
                                        <option label="Si" value="1">Si</option>
                                        <option label="No" value="0" selected>No</option>
                                    {% endif %}
                                </select>
                                <small>Invia una mail usanto il template defaut, se esiste</small>
                            </div>
                        </div>
                        <div class="col col-sm-4">
                            <div id="form-group-send_mail_update" class="form-group">
                                <label for="send_mail_update" class="control-label">Invia Mail all'
                                    Aggiornamento</label>
                                <select id="send_mail_update" name="send_mail_update" class="form-control  ">
                                    {% if 'send_mail_update' in properties  and properties['send_mail_update'] %}
                                        <option label="Si" value="1"
                                                {% if (properties['send_mail_update']|string == "1") %}
                                                selected {% endif %}>Si
                                        </option>
                                        <option label="No" value="0"
                                                {% if (properties['send_mail_update']|string == "0") %}
                                                selected {% endif %}>No
                                        </option>
                                    {% else %}
                                        <option label="Si" value="1">Si</option>
                                        <option label="No" value="0" selected>No</option>
                                    {% endif %}
                                </select>
                                <small>Invia una mail usanto il template defaut, se esiste</small>
                            </div>
                        </div>
                        <div class="col col-sm-4">
                            <div id="form-group-title" class="form-group">
                                <label for="title" class="control-label">Eliminato</label>
                                <input type="number" class="form-control"
                                       id="deleted" name="deleted" required value="{{ deleted|safe }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col col-sm-4">
                            <div id="form-group-query-form-editable" class="form-group">
                                <label for="query-form-editable" class="control-label">Query</label>
                                <textarea id="query-form-editable" type="textarea" class="form-control"
                                          name="query-form-editable" autocomplete="off"
                                >{{ queryformeditable |safe }}</textarea>
                                <small>Form Readonly se la query e' valida, la regola e' ignorata se ce' un model access
                                    attivo</small>
                            </div>
                        </div>
                        <div class="col col-sm-4">
                            <div id="form-group-title" class="form-group">
                                <label for="sort" class="control-label">Order by</label>
                                <input type="text" class="form-control"
                                       id="sort" name="sort" required value="{{ sort|safe }}">
                                <small>campi divisi da vrsola: nome:asc|des es:
                                    rec_name:asc,create_datetime:desc</small>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row container-fluid text-center">
            {% for btn in action_buttons %}
                {% if  btn['btn_action_type'] == "post" %}
                    <div class=" {{ btn['cls'] }} col-lg-2 ">
                        <button type="button" id="{{ btn['key'] }}" class="btn btn-warning btn-md"
                                {% if btn.get('disabled') %} disabled {% endif %}>
                            <span class="sr-only">{{ btn['label'] }}</span>
                            {% if btn['leftIcon'] %}
                                <svg class="icon" width="32" height="32">
                                    <use href="/static/svg/sprite.svg#{{ btn['leftIcon'] }}"></use>
                                </svg>
                                <span>{{ btn['label'] }}</span>
                            {% else %}
                                {{ btn['label'] }}
                            {% endif %}
                        </button>
                    </div>
                {% endif %}
            {% endfor %}

            <input type="textarea" id="json" name="components" disabled autocomplete="off" class=" d-none">
        </div>
    </form>
    <p class="text-center text-muted mb-0" style="font-size: 0.8em">Formio Renderer v<span
            id="renderer-version"></span></p>

</div>

<script type="text/javascript">

    String.prototype.underscorize = function () {
        return this.replace(/ /g, "_").toLowerCase();
    };

    function array_bool(arr, key) {
        var rec = arr[arr.findIndex(x => x.name === key)];
        arr[arr.findIndex(x => x.name === key)].value = (rec.value === "1")
        return arr
    }

    {% for btn in action_buttons %}
        {% if  btn['btn_action_type'] == "post" %}
            $("#{{ btn['key'] }}").on('click', function (e) {
                e.preventDefault(); // disable the POST of the form by the submit button
                // $(this).$("#")
                var self = this;
                if ($("#fproject").valid()) {
                    var datax = $("#fproject").serializeArray();
                    //console.log(datax)
                    var data = datax.filter(function (dat) {
                        return !dat.name.startsWith("data[");
                    });

                    var sck = builder.instance.schema
                    if (sck.hasOwnProperty("display")) {
                        delete sck.display
                    }
                    //console.log(window.editor.getData());
                    var report_data = window.editor.getData();


                    // jsonElement.value = JSON.stringify(sck);
                    data.push({name: 'components', value: sck['components']});
                    data.push({name: 'report', value: report_data});
                    data = array_bool(data, 'sys');
                    console.log(data);
                    $.ajax({
                        type: "{{ btn['btn_action_type'] }}",
                        url: "{{ btn['url_action'] }}?builder=true",
                        headers: {
                            {% if security_headers %}
                                {% for k,v in security_headers.items() %}
                                    "{{ k }}": "{{ v }}",
                                {% endfor %}
                            {% endif %}
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(data),
                        beforeSend: function () {
                            $("#loader").removeClass("d-none");
                        },
                        error: function (e) {
                            $("#loader").addClass("d-none");
                            alert("Errore Interno contattare Helpdesk", e);
                        },
                        success: function (result) {
                            if ((result.hasOwnProperty('link')) && result.reload) {
                                if (result.link === "#") {
                                    window.location.reload();
                                } else {
                                    parent.gotolink(result.link);
                                }
                            }
                            for (var item in result) {
                                $(result[item].selector).replaceWith(result[item].value);
                            }
                            for (var item in result) {
                                if (result[item].selector.includes('alert')) {
                                    var yc = $(result[item].selector).offset().top;
                                    $("html, body").animate({scrollTop: yc}, "slow");
                                    break;
                                }
                            }
                            $("#loader").addClass("d-none");
                        },
                    });
                }

            });
        {% endif %}
    {% endfor %}

    var tt_input_mask = "An input mask helps the user with input by ensuring a predefined format.<br><br> Available Alias <br> <br> mac, ip, date, euro, numericit, sci, mail, currency, euroComplex, numeric, url<br><br> or custom <br>9: numeric<br>a: alphabetical<br>*: alphanumeric<br><br>Example telephone mask: (999) 999-9999<br><br>See the <a target='_blank' href='https://github.com/RobinHerbots/jquery.inputmask'>jquery.inputmask documentation</a> for more information.";
    var tt_datetime = "use today.<br><br> ";
    var components = Formio.Components.components;
    var textFieldEdit = components.textfield.editForm();
    var dateFieldEdit = components.datetime.editForm();
    var jsonElement = document.getElementById('json');
    var subJSON = document.getElementById('subjson');
    var baseurl = window.location.origin + "/client/data";

    components.textfield.editForm = function () {
        for (var i = 0; i < textFieldEdit.components.length; i++) {
            if (textFieldEdit.components[i].key === 'tabs') {
                var tabs = textFieldEdit.components[i];
                for (var j = 0; j < tabs.components.length; j++) {
                    if (tabs.components[j].key === 'display') {
                        var x = tabs.components;
                        // console.log(x);
                        var objIndex = x[j].components.findIndex((obj => obj.key === 'inputMask'));
                        x[j].components[objIndex].weight = 101;
                        x[j].components[objIndex].tooltip = tt_input_mask;
                        x[j].components[objIndex].placeholder = "Alias: mac, ip, date, euro, numericit, sci, mail, currency, euroComplex, numeric, url";
                    }
                }
            }
        }
        return textFieldEdit;
    };

    var builder = new Formio.FormBuilder(document.getElementById("builder"),
        {
            display: 'form',
            components: {{ components|safe or [] }},

        },
        {
            baseUrl: baseurl,
            projectId: "",
            builder: {
                basic: {
                    components: {
                        selectboxes: false,
                        "rec_name": {
                            "title": "Field Name",
                            "icon": "external-link",
                            "schema": {
                                "label": "Name",
                                "key": "rec_name",
                                "type": "textfield",
                                "input": true,
                                "hidden": false,
                                "tableView": true
                            }
                        },
                        button: {
                            title: 'Button',
                            icon: 'stop',
                            group: 'basic',
                            weight: 6,
                            schema: {
                                label: 'Button',
                                showValidations: false,
                                theme: 'warning',
                                block: true,
                                customClass: 'btn-outline-primary',
                                tableView: false,
                                key: 'action1',
                                properties: {
                                    btn_action_type: 'post',
                                    url_action: 'url_action'
                                },
                                type: 'button',
                                input: true,
                                hideOnChildrenHidden: false
                            }
                        },
                        buttonalert: {
                            title: 'Button Alert',
                            icon: 'window-maximize',
                            group: 'basic',
                            weight: 10,
                            schema: {
                                label: 'Button Alert',
                                showValidations: false,
                                theme: 'warning',
                                rightIcon: 'it-external-link',
                                customClass: 'btn-outline-primary',
                                tableView: false,
                                modalEdit: true,
                                key: 'buttonAlert',
                                properties: {
                                    modal_title: 'Alert Title',
                                    modal_message: 'Alert Message',
                                    btn_modal_label: 'Yes',
                                    btn_action_type: 'post',
                                    url_action: 'url_action'
                                },
                                type: 'button',
                                input: true,
                                hideOnChildrenHidden: false
                            }
                        },
                        buttondelete: {
                            title: 'Button Delete Record',
                            icon: 'trash',
                            group: 'basic',
                            weight: 10,
                            schema: {
                                label: 'Elimina',
                                showValidations: false,
                                theme: 'danger',
                                leftIcon: 'it-delete',
                                rightIcon: 'it-delete',
                                customClass: 'btn-danger',
                                tableView: false,
                                modalEdit: true,
                                key: 'elimina',
                                properties: {
                                    modal_title: 'Attenzione',
                                    modal_message: 'Vuoi veramente eliminare il record?',
                                    btn_modal_label: 'Si',
                                    btn_action_type: 'post',
                                    url_action: 'url_action'
                                },
                                logic: [
                                    {
                                        name: 'delete active',
                                        trigger: {
                                            type: 'json',
                                            json: {
                                                "!": [
                                                    {
                                                        "and": [
                                                            {
                                                                "var": [
                                                                    "form.rec_name",
                                                                    false
                                                                ]
                                                            },
                                                            {
                                                                "in": [
                                                                    {
                                                                        "var": "user.uid"
                                                                    },
                                                                    {
                                                                        "var": "user.allowed_users"
                                                                    }
                                                                ]
                                                            },
                                                            {
                                                                "==": [
                                                                    {
                                                                        "var": "form.deleted"
                                                                    },
                                                                    0
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        },
                                        actions: [
                                            {
                                                name: 'activate button',
                                                type: 'property',
                                                property: {
                                                    label: 'Hidden',
                                                    value: 'hidden',
                                                    type: 'boolean'
                                                },
                                                state: true
                                            }
                                        ]
                                    },
                                    {
                                        name: 'compute delete url',
                                        trigger: {
                                            type: 'json',
                                            json: {
                                                "cat": [
                                                    "/action/delete_",
                                                    {
                                                        "var": "form.data_model"
                                                    },
                                                    "/",
                                                    {
                                                        "var": "form.rec_name"
                                                    }
                                                ]
                                            }
                                        },
                                        actions: [
                                            {
                                                name: 'update value',
                                                type: 'value',
                                                value: 'url_action'
                                            }
                                        ]
                                    }
                                ],
                                type: 'button',
                                input: true,
                                hideOnChildrenHidden: false
                            }
                        },

                    }
                },
                advanced: {
                    components: {
                        model_list: {
                            title: 'Model list',
                            group: 'advanced',
                            icon: 'list',
                            schema: {
                                "label": "Model",
                                "widget": "choicesjs",
                                "tableView": true,
                                "dataSrc": "url",
                                "data": {
                                    "url": "/models/distinct",
                                    "headers": [
                                        {
                                            "key": "",
                                            "value": ""
                                        }
                                    ]
                                },
                                "validate": {
                                    "required": true
                                },
                                "key": "model",
                                "properties": {
                                    "id": "rec_name",
                                    "label": "title",
                                    "domain": "{}",
                                    "model": "component"
                                },
                                "type": "select",
                                "input": true,
                                "hideOnChildrenHidden": false,
                                "disableLimit": false
                            },
                        },
                        tags: false,
                        url: false,
                        address: false,
                        day: false,
                        time: false,
                        currency: false,
                        signature: false,
                        datetime: {
                            title: 'Date / Time',
                            group: 'advanced',
                            icon: 'calendar',
                            weight: 40,
                            schema: {
                                type: 'datetime',
                                label: 'Date / Time',
                                key: 'dateTime',
                                format: 'd/m/Y H:i:S',
                                useLocaleSettings: false,
                                customClass: "",
                                tableView: true,
                                allowInput: true,
                                enableDate: true,
                                enableTime: true,
                                defaultValue: '',
                                defaultDate: '',
                                displayInTimezone: 'viewer',
                                datepickerMode: 'day',
                                datePicker: {
                                    showWeeks: true,
                                    startingDay: 0,
                                    initDate: '',
                                    minMode: 'day',
                                    maxMode: 'year',
                                    yearRows: 4,
                                    yearColumns: 5,
                                    minDate: null,
                                    maxDate: null
                                },
                                timePicker: {
                                    hourStep: 1,
                                    minuteStep: 1,
                                    showMeridian: true,
                                    readonlyInput: false,
                                    mousewheel: true,
                                    arrowkeys: true
                                },

                            }
                        },
                        printdata: {
                            title: "Pulsante Stampa",
                            gorup: 'advanced',
                            icon: 'print',
                            weight: 50,
                            schema: {
                                label: 'Stampa',
                                tag: 'a',
                                attrs: [
                                    {
                                        attr: 'target',
                                        value: '_blank'
                                    },
                                    {
                                        attr: 'icon',
                                        value: 'it-print'
                                    }
                                ],
                                content: 'stampa',
                                refreshOnChange: false,
                                customClass: 'mx-auto col-md-8 mt-1 mb-1 btn',
                                key: 'ilink',
                                logic: [
                                    {
                                        name: 'url maker',
                                        trigger: {
                                            type: 'json',
                                            json: {
                                                cat: [
                                                    '/client/print/form/',
                                                    {
                                                        'var': 'app.curr_model'
                                                    },
                                                    '/',
                                                    {
                                                        'var': 'form.rec_name'
                                                    }
                                                ]
                                            }
                                        },
                                        actions: [
                                            {
                                                name: 'make content',
                                                type: 'value',
                                                value: 'content'
                                            }
                                        ]
                                    }
                                ],
                                type: 'htmlelement',
                                input: false,
                                tableView: false
                            }
                        },
                        editor: {
                            title: "Editor",
                            group: "advanced",
                            icon: 'paragraph',
                            schema: {
                                "html": "<p>Testo</p>",
                                "label": "Editor",
                                "refreshOnChange": false,
                                "key": "editor",
                                "properties": {
                                    "editor": "active"
                                },
                                "type": "content",
                                "input": false,
                                "tableView": false
                            }
                        },
                        jsoneditor: {
                            title: "JsonEditor",
                            group: "advanced",
                            icon: 'align-left',
                            schema: {
                                "label": "Text Area",
                                "autoExpand": false,
                                "tableView": false,
                                "inputFormat": "plain",
                                "dfaultValue": "{}",
                                "key": "textArea",
                                "properties": {
                                    "type": "json"
                                },
                                "type": "textarea",
                                "input": true
                            }
                        },
                        admin_todo: {
                            title: "Todo Supervised",
                            group: "advanced",
                            icon: 'list-ul',
                            schema: {
                                "legend": "Supervised Todo",
                                "key": "supervised_todo",
                                "properties": {
                                    "rec_name": "supervised_todo",
                                    "action_type": "task",
                                    "type": "data",
                                    "mode": "form",
                                    "admin": "true"
                                },
                                "type": "fieldset",
                                "label": "Supervised Todo",
                                "input": false,
                                "tableView": false,
                                "components": [
                                    {
                                        "label": "Fatto",
                                        "showValidations": false,
                                        "theme": "warning",
                                        "block": true,
                                        "customClass": "btn-outline-primary",
                                        "tableView": false,
                                        "key": "btn_admin_todo",
                                        "properties": {
                                            "btn_action_type": "post",
                                            "url_action": "/action/_model/supervised_todo",
                                            "leftIcon": "it-check-circle"
                                        },
                                        "logic": [
                                            {
                                                "name": "check",
                                                "trigger": {
                                                    "type": "json",
                                                    "json": {
                                                        "==": [1, 1]
                                                    }
                                                },
                                                "actions": [
                                                    {
                                                        "name": "set visible",
                                                        "type": "value",
                                                        "value": 'hidden={"!":[{"and":[{"var":["form.todo", false]},{"var":["is_admin", false]}]}]}'
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "eval url",
                                                "trigger": {
                                                    "type": "json",
                                                    "json": {
                                                        "cat": [
                                                            "/action/",
                                                            {
                                                                "var": "app.curr_model"
                                                            },
                                                            "_supervised_todo",
                                                            "/",
                                                            {
                                                                "var": "form.rec_name"
                                                            }
                                                        ]
                                                    }
                                                },
                                                "actions": [
                                                    {
                                                        "name": "set value",
                                                        "type": "value",
                                                        "value": "url_action"
                                                    }
                                                ]
                                            }
                                        ],
                                        "type": "button",
                                        "input": true,
                                        "hideOnChildrenHidden": false,
                                        "saveOnEnter": false
                                    },
                                    {
                                        "label": "Todo",
                                        "hidden": true,
                                        "tableView": false,
                                        "defaultValue": false,
                                        "calculateValue": "eval_data",
                                        "calculateServer": true,
                                        "key": "todo",
                                        "type": "checkbox",
                                        "input": true
                                    }
                                ]
                            }
                        },
                        user_todo: {
                            title: "Todo User",
                            group: "advanced",
                            icon: 'list-ul',
                            schema: {
                                "legend": "User Todo",
                                "key": "user_todo",
                                "properties": {
                                    "rec_name": "user_todo",
                                    "action_type": "task",
                                    "type": "data",
                                    "mode": "form"
                                },
                                "type": "fieldset",
                                "label": "User Todo",
                                "input": false,
                                "tableView": false,
                                "components": [
                                    {
                                        "label": "Fatto",
                                        "showValidations": false,
                                        "theme": "warning",
                                        "block": true,
                                        "customClass": "btn-outline-primary",
                                        "tableView": false,
                                        "key": "btn_user_todo",
                                        "properties": {
                                            "btn_action_type": "post",
                                            "url_action": "/action/model/submit_test_todo",
                                            "leftIcon": "it-check-circle"
                                        },
                                        "logic": [
                                            {
                                                "name": "check",
                                                "trigger": {
                                                    "type": "json",
                                                    "json": {
                                                        "==": [1, 1]
                                                    }
                                                },
                                                "actions": [
                                                    {
                                                        "name": "set visible",
                                                        "type": "value",
                                                        "value": 'hidden={"!":{"var":["form.todo", false]}}'
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "eval url",
                                                "trigger": {
                                                    "type": "json",
                                                    "json": {
                                                        "cat": [
                                                            "/action/",
                                                            {
                                                                "var": "app.curr_model"
                                                            },
                                                            "_user_todo",
                                                            "/",
                                                            {
                                                                "var": "form.rec_name"
                                                            }
                                                        ]
                                                    }
                                                },
                                                "actions": [
                                                    {
                                                        "name": "set value",
                                                        "type": "value",
                                                        "value": "url_action"
                                                    }
                                                ]
                                            }
                                        ],
                                        "type": "button",
                                        "input": true,
                                        "hideOnChildrenHidden": false,
                                        "saveOnEnter": false
                                    },
                                    {
                                        "label": "Todo",
                                        "hidden": true,
                                        "tableView": false,
                                        "defaultValue": false,
                                        "calculateValue": "eval_user_todo",
                                        "calculateServer": true,
                                        "key": "todo",
                                        "type": "checkbox",
                                        "input": true
                                    }
                                ]
                            }
                        }
                    }

                },
                layout: {
                    components: {
                        well: false,
                        table: false,
                        fieldset: false,
                        "app_link": {
                            "title": "Link",
                            "key": "app_link",
                            "icon": "link",
                            "schema": {
                                "label": "New Link",
                                "type": "htmlelement",
                                "key": "ilink",
                                "tag": "a",
                                "content": "https://...",
                                "customClass": "mx-auto col-md-8 mt-1 mb-1",
                                "attrs": [
                                    {
                                        "attr": "target",
                                        "value": "_blank"
                                    },
                                    {
                                        "attr": "icon",
                                        "value": ""
                                    }
                                ]
                            }
                        }
                    }
                },
                data: {
                    components: {
                        hidden: false,
                        search: {
                            title: 'Search Area',
                            key: 'custom_search',
                            icon: 'search',
                            schema: {
                                "label": "Search Area",
                                "customClass": "col-12",
                                "key": "search_area",
                                "properties": {
                                    "type": "search_area",
                                    "query": "{}",
                                    "model": "_model_",
                                    "object": "table",
                                    "object_id": "_table_id_"
                                },
                                "logic": [
                                    {
                                        "name": "all",
                                        "trigger": {
                                            "type": "json",
                                            "json": {
                                                "==": [
                                                    1,
                                                    1
                                                ]
                                            }
                                        },
                                        "actions": [
                                            {
                                                "name": "eval query",
                                                "type": "value",
                                                "value": "query={\"cat\":[\"{'parent':'\", {\"var\":\"form.rec_name\"}, \"'}\"]}"
                                            }
                                        ]
                                    }
                                ],
                                "type": "well",
                                "input": false,
                                "tableView": false,
                                "components": []
                            },
                        },
                        export: {
                            title: "Export Area",
                            key: "export_area",
                            icon: "pdf",
                            schema: {
                                "label": "Export Area",
                                "customClass": "col-12",
                                "key": "export_area",
                                "properties": {
                                    "type": "export_area",
                                    "search_id": "search_area",
                                    "model": "_model_",
                                    "query": "{}",
                                    "hide_all": "si",
                                    "csv_f": "CSV",
                                    "xls_f": "XLS",
                                    "json_f": "JSON"
                                },
                                "logic": [
                                    {
                                        "name": "check",
                                        "trigger": {
                                            "type": "json",
                                            "json": {
                                                "var": "form.rec_name"
                                            }
                                        },
                                        "actions": [
                                            {
                                                "name": "make query",
                                                "type": "value",
                                                "value": "query={\"cat\":[\"{'parent':'\", {\"var\":\"form.rec_name\"}, \"'}\"]}"
                                            }
                                        ]
                                    }
                                ],
                                "type": "well",
                                "input": false,
                                "tableView": false,
                                "components": []
                            },
                        },
                        table: {
                            title: 'Table',
                            key: 'table',
                            icon: 'table',
                            schema: {
                                label: "Table",
                                key: "table",
                                properties: {
                                    action_url: "action url",
                                    model: "model",
                                    show_owner: 'no',
                                    hide_select_chk: 'no',
                                    list_metadata_show: "list_order,",
                                    dom: "iptilp"
                                },
                                type: "table",
                                customClass: "table table-borderless p-2",
                                input: false,
                                tableView: false,
                                components: []
                            }
                        },
                        datamap: false,
                        editgrid: false,
                        tree: false,
                        container: false,
                    }
                },
                premium: {
                    components: {
                        form: false,
                        resource: false,
                        recaptcha: false,
                        unknown: false
                    }
                },
                custom: {{ custom_builder_components |safe or {} }},
                {% if not parent_model_components == "{}" %}
                    modelfield: {
                        title: "Parent Model Fields",
                        weight: 0,
                        components: {{ parent_model_components |safe or {} }},
                    }
                {% endif %}
            },

        }
    );


    var onForm = function (form) {
        form.on('change', function () {
            subJSON.innerHTML = '';
            subJSON.appendChild(document.createTextNode(JSON.stringify(form.submission, null, 0)));
        });
    };

    var onBuild = function (build) {
        var sck = builder.instance.schema
        if (sck.hasOwnProperty("display")) {
            delete sck.display
        }
        jsonElement.value = JSON.stringify(sck);
        // jsonElement.appendChild(document.createTextNode(JSON.stringify(builder.instance.schema, null, 4)));
        // Formio.createForm(formElement, builder.instance.form).then(onForm);
    };

    var onReady = function () {
        var jsonElement = document.getElementById('json');
        builder.instance.on('change', onBuild);
    };

    builder.instance.ready.then(onReady);
    var serialize = function (x) {
        return JSON.stringify(x, function (k, v) {
            if (!k.startsWith("data"))
                return v;
        });
    };

    $("#title").blur(function () {
        if ($("#rec_name").val() == "") {
            $("#rec_name").val($(this).val().underscorize());
        }
    });
    // Ckeditor
    window.CKEDITOR_VERSION = false


    DecoupledEditor.defaultConfig = {
        toolbar: {
            items: [
                'heading',
                '|',
                'fontfamily',
                'fontsize',
                'fontColor',
                'fontBackgroundColor',
                '|',
                'bold',
                'italic',
                'underline',
                'strikethrough',
                '|',
                'alignment',
                '|',
                'numberedList',
                'bulletedList',
                '|',
                'indent',
                'outdent',
                '|',
                'link',
                'blockquote',
                //'imageUpload',
                'insertTable',
                // 'mediaEmbed',
                '|',
                'undo',
                'redo'
            ]
        },
        image: {
            styles: [
                'full',
                'alignLeft',
                'alignRight'
            ],
            toolbar: [
                'imageStyle:alignLeft',
                'imageStyle:full',
                'imageStyle:alignRight',
                '|',
                'imageTextAlternative'
            ]
        },
        table: {
            contentToolbar: [
                'tableColumn',
                'tableRow',
                'mergeTableCells',
                'tableProperties',
                'tableCellProperties'
            ]
        },
        language: 'it'
    };
    DecoupledEditor.create(document.querySelector('#report'))
        .then(editor => {
            const toolbarContainer = document.querySelector('#toolbar-container');

            toolbarContainer.appendChild(editor.ui.view.toolbar.element);
            window.editor = editor;

        })
        .catch(error => {
            console.error(error);
        });

</script>
</body>
</html>